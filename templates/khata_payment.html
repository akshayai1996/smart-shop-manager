<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Khata Payment - {{ customer.name }} | ShopEase</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #3399cc;
            --bg: #f4f6f8;
            --text: #0b2135;
            --surface: #ffffff;
            --border: #e2e8f0;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: var(--text);
        }
        .payment-container {
            display: flex;
            background: var(--surface);
            width: 900px;
            min-height: 550px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border-radius: 8px;
            overflow: hidden;
        }
        .order-summary {
            background: linear-gradient(135deg, #38a169, #276749);
            color: white;
            width: 35%;
            padding: 40px;
            box-sizing: border-box;
        }
        .logo { font-size: 24px; font-weight: 700; margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
        .order-details h2 { font-size: 14px; text-transform: uppercase; letter-spacing: 1px; opacity: 0.7; margin-bottom: 20px; }
        .amount-display { margin-bottom: 30px; }
        .amount-value { font-size: 32px; font-weight: 700; }
        .amount-currency { font-size: 16px; font-weight: 500; opacity: 0.8; }
        .customer-info { background: rgba(255,255,255,0.15); padding: 15px; border-radius: 6px; }
        .customer-info .label { font-size: 12px; opacity: 0.7; text-transform: uppercase; letter-spacing: 0.5px; }
        .customer-info .value { font-weight: 600; font-size: 16px; margin-bottom: 8px; }

        .payment-options { width: 65%; padding: 40px; box-sizing: border-box; background: #fff; }
        .payment-options h2 { margin-top: 0; margin-bottom: 25px; font-size: 20px; }

        .tabs { display: flex; gap: 20px; margin-bottom: 30px; border-bottom: 1px solid var(--border); }
        .tab { padding: 10px 0; cursor: pointer; color: #718096; font-weight: 500; position: relative; display: flex; align-items: center; gap: 6px; }
        .tab.active { color: var(--primary); }
        .tab.active::after { content: ''; position: absolute; bottom: -1px; left: 0; width: 100%; height: 2px; background: var(--primary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 8px; color: #4a5568; }
        .form-input { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 4px; font-size: 14px; box-sizing: border-box; transition: border-color 0.2s; }
        .form-input:focus { outline: none; border-color: var(--primary); }
        .form-row { display: flex; gap: 20px; }
        .btn-pay { background: #38a169; color: white; border: none; width: 100%; padding: 14px; border-radius: 4px; font-size: 16px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .btn-pay:hover { background: #2f855a; }

        .upi-container { text-align: center; padding: 20px; border: 1px dashed var(--border); border-radius: 8px; margin-bottom: 20px; }
        .qr-code { width: 200px; height: 200px; margin-bottom: 15px; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 30px; border-radius: 8px; width: 300px; text-align: center; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #38a169; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .back-link { display: inline-block; margin-bottom: 15px; color: #667eea; text-decoration: none; font-size: 14px; }
        .back-link:hover { text-decoration: underline; }
    </style>
</head>
<body>

<div class="payment-container">
    <!-- Left: Customer & Amount Info -->
    <div class="order-summary">
        <div class="logo"><i class="fas fa-book"></i> Khata Payment</div>
        <div class="order-details">
            <h2>Payment Collection</h2>
            <div class="amount-display">
                <div class="amount-currency">Collecting</div>
                <div class="amount-value">₹ {{ "{:,.2f}".format(amount) }}</div>
            </div>
            <div class="customer-info">
                <div class="label">Customer</div>
                <div class="value">{{ customer.name }}</div>
                <div class="label">Phone</div>
                <div class="value">{{ customer.phone }}</div>
                <div class="label" style="margin-top:10px;">Outstanding Balance</div>
                <div class="value" style="color:#fbd38d;">₹{{ "{:,.2f}".format(customer.balance|float) }}</div>
            </div>
            <div style="margin-top:30px;font-size:12px;opacity:0.6;">
                <i class="fas fa-lock"></i> Secured by EasePay
            </div>
        </div>
    </div>

    <!-- Right: Payment Form -->
    <div class="payment-options">
        <a href="{{ url_for('khatabook.ledger', customer_id=customer.id) }}" class="back-link">
            <i class="fas fa-arrow-left"></i> Back to Ledger
        </a>
        <h2>Receive Payment from {{ customer.name }}</h2>

        <div class="tabs">
            <div class="tab {{ 'active' if payment_mode == 'card' }}" onclick="switchTab('card')"><i class="far fa-credit-card"></i> Card</div>
            <div class="tab {{ 'active' if payment_mode == 'upi' }}" onclick="switchTab('upi')"><i class="fas fa-qrcode"></i> UPI / QR</div>
            <div class="tab {{ 'active' if payment_mode == 'cash' }}" onclick="switchTab('cash')"><i class="fas fa-money-bill-wave"></i> Cash</div>
        </div>

        <!-- Card Form -->
        <form id="card-form" class="tab-content {{ 'active' if payment_mode == 'card' }}" 
              action="{{ url_for('payment.khata_process_payment') }}" method="POST" onsubmit="handlePayment(event, 'Card')">
            <input type="hidden" name="customer_id" value="{{ customer.id }}">
            <input type="hidden" name="payment_method" value="Card">
            
            <div class="form-group">
                <label class="form-label">Payment Amount (₹) <span style="color:#e53e3e">*</span></label>
                <input type="number" name="amount" class="form-input" value="{{ amount }}" min="0.01" step="0.01" required
                       max="{{ customer.balance|float }}">
                <small style="color:#718096;">Max: ₹{{ "{:,.2f}".format(customer.balance|float) }}</small>
            </div>

            <div class="form-group">
                <label class="form-label">Card Number <span style="color:#e53e3e">*</span></label>
                <input type="text" id="cardNumber" class="form-input" placeholder="XXXX XXXX XXXX XXXX" maxlength="19" required
                       oninput="formatCardNumber(this)" pattern="[0-9 ]{19}" autocomplete="off">
            </div>
            <div class="form-row">
                <div class="form-group" style="flex:1;">
                    <label class="form-label">Expiry <span style="color:#e53e3e">*</span></label>
                    <input type="text" id="expiryDate" class="form-input" placeholder="MM/YY" maxlength="5" required
                           oninput="formatExpiry(this)" pattern="(0[1-9]|1[0-2])\/[0-9]{2}" autocomplete="off">
                </div>
                <div class="form-group" style="flex:1;">
                    <label class="form-label">CVV <span style="color:#e53e3e">*</span></label>
                    <input type="password" id="cvv" class="form-input" placeholder="123" maxlength="3" required
                           oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,3)" pattern="[0-9]{3}" autocomplete="off">
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Card Holder Name <span style="color:#e53e3e">*</span></label>
                <input type="text" id="cardName" class="form-input" placeholder="Name on Card" required
                       oninput="this.value=this.value.replace(/[^a-zA-Z\s]/g,'')">
            </div>
            <button type="submit" class="btn-pay"><i class="fas fa-lock"></i> Collect Payment</button>
        </form>

        <!-- UPI Form -->
        <div id="upi-form" class="tab-content {{ 'active' if payment_mode == 'upi' }}">
            <div class="upi-container">
                <img src="{{ url_for('payment.qr_code') }}" class="qr-code" alt="UPI QR Code">
                <p style="font-size:14px;color:#4a5568;">Ask customer to scan & pay</p>
                <p style="font-weight:600;color:#38a169;">shopease@dummybank</p>
            </div>
            <form action="{{ url_for('payment.khata_process_payment') }}" method="POST" onsubmit="handleUPI(event)">
                <input type="hidden" name="customer_id" value="{{ customer.id }}">
                <input type="hidden" name="payment_method" value="UPI">
                <div class="form-group">
                    <label class="form-label">Payment Amount (₹) <span style="color:#e53e3e">*</span></label>
                    <input type="number" name="amount" class="form-input" value="{{ amount }}" min="0.01" step="0.01" required
                           max="{{ customer.balance|float }}">
                </div>
                <button type="submit" class="btn-pay">Confirm UPI Payment Received</button>
            </form>
        </div>

        <!-- Cash Form -->
        <div id="cash-form" class="tab-content {{ 'active' if payment_mode == 'cash' }}">
            <div style="text-align:center;padding:20px;margin-bottom:20px;">
                <i class="fas fa-money-bill-wave" style="font-size:64px;color:#38a169;margin-bottom:15px;"></i>
                <p style="font-size:16px;color:#4a5568;">Record cash payment from customer</p>
            </div>
            <form action="{{ url_for('payment.khata_process_payment') }}" method="POST">
                <input type="hidden" name="customer_id" value="{{ customer.id }}">
                <input type="hidden" name="payment_method" value="Cash">
                <div class="form-group">
                    <label class="form-label">Cash Amount (₹) <span style="color:#e53e3e">*</span></label>
                    <input type="number" name="amount" class="form-input" value="{{ amount }}" min="0.01" step="0.01" required
                           max="{{ customer.balance|float }}">
                </div>
                <button type="submit" class="btn-pay"><i class="fas fa-check"></i> Record Cash Payment</button>
            </form>
        </div>
    </div>
</div>

<!-- OTP Modal -->
<div id="otp-modal" class="modal">
    <div class="modal-content">
        <h3>Verify Transaction</h3>
        <p>Enter the OTP sent to customer's mobile</p>
        <div class="form-group">
            <input type="text" id="otpInput" class="form-input" placeholder="Enter OTP" maxlength="6"
                   style="text-align:center;letter-spacing:5px;font-size:20px;"
                   oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,6)">
        </div>
        <button class="btn-pay" onclick="verifyOtp()">Verify & Collect</button>
        <div id="processing" style="display:none;margin-top:20px;">
            <div class="spinner"></div>
            <p>Processing...</p>
        </div>
    </div>
</div>

<script>
    function switchTab(tab) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        const tabs = document.querySelectorAll('.tab');
        tabs.forEach(t => {
            const text = t.textContent.trim().toLowerCase();
            if ((tab === 'card' && text.includes('card')) ||
                (tab === 'upi' && text.includes('upi')) ||
                (tab === 'cash' && text.includes('cash'))) {
                t.classList.add('active');
            }
        });
        document.getElementById(tab + '-form').classList.add('active');
    }

    function formatCardNumber(input) {
        let v = input.value.replace(/[^0-9]/g, '').slice(0, 16);
        input.value = v.replace(/(\d{4})(?=\d)/g, '$1 ');
    }
    function formatExpiry(input) {
        let v = input.value.replace(/[^0-9]/g, '').slice(0, 4);
        if (v.length >= 3) v = v.slice(0,2) + '/' + v.slice(2);
        input.value = v;
    }

    let formToSubmit = null;

    function handlePayment(e, method) {
        e.preventDefault();
        formToSubmit = e.target;
        const cardNum = document.getElementById('cardNumber').value.replace(/\s/g,'');
        const expiry = document.getElementById('expiryDate').value;
        const cvv = document.getElementById('cvv').value;
        const name = document.getElementById('cardName').value.trim();
        if (!/^[0-9]{16}$/.test(cardNum)) { alert('Card number must be exactly 16 digits.'); return; }
        if (!/^(0[1-9]|1[0-2])\/[0-9]{2}$/.test(expiry)) { alert('Expiry must be in MM/YY format.'); return; }
        if (!/^[0-9]{3}$/.test(cvv)) { alert('CVV must be exactly 3 digits.'); return; }
        if (!/^[a-zA-Z\s]+$/.test(name)) { alert('Name must contain only letters.'); return; }
        document.getElementById('otp-modal').style.display = 'flex';
    }

    function handleUPI(e) {
        e.preventDefault();
        formToSubmit = e.target;
        const btn = e.target.querySelector('button');
        btn.innerText = 'Verifying...';
        btn.disabled = true;
        setTimeout(() => { formToSubmit.submit(); }, 2000);
    }

    function verifyOtp() {
        const otp = document.getElementById('otpInput').value.trim();
        if (!otp) { alert('Please enter the OTP.'); return; }
        document.getElementById('processing').style.display = 'block';
        setTimeout(() => { formToSubmit.submit(); }, 1500);
    }
</script>

</body>
</html>
