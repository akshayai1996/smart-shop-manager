{% extends "base.html" %}

{% block title %}Analytics - ShopEase{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="fas fa-chart-pie"></i> Business Analytics - {{ current_month }}</h1>
    <div class="date-range">{{ today_date_formatted }}</div>
</div>

<!-- Summary Cards -->
<div class="cards">
    <div class="card">
        <div class="card-icon"><i class="fas fa-calendar-day"></i></div>
        <div class="card-content">
            <h3>Today's Sales</h3>
            <p class="big-number">₹{{ "{:,.0f}".format(today_sales|default(0)|float) }}</p>
            <span class="card-label">{{ today_date_formatted }}</span>
        </div>
    </div>
    
    <div class="card">
        <div class="card-icon"><i class="fas fa-calendar-alt"></i></div>
        <div class="card-content">
            <h3>This Month</h3>
            <p class="big-number">₹{{ "{:,.0f}".format(monthly_sales|default(0)|float) }}</p>
            <span class="card-label">{{ current_month }} {{ now.year }}</span>
        </div>
    </div>
    
    <div class="card">
        <div class="card-icon"><i class="fas fa-chart-bar"></i></div>
        <div class="card-content">
            <h3>Avg Daily (30d)</h3>
            <p class="big-number">₹{{ "{:,.0f}".format(avg_daily|default(0)|float) }}</p>
            <span class="card-label">Last 30 days average</span>
        </div>
    </div>
    
    <div class="card highlight">
        <div class="card-icon"><i class="fas fa-trophy"></i></div>
        <div class="card-content">
            <h3>Best Day Ever</h3>
            <p class="big-number">₹{{ "{:,.0f}".format(best_day|default(0)|float) }}</p>
            <span class="card-label">{{ best_day_date|default('') }}</span>
        </div>
    </div>
</div>

<!-- Additional Metrics Row -->
<div class="metrics-row">
    <div class="metric-card">
        <div class="metric-icon"><i class="fas fa-chart-line"></i></div>
        <div class="metric-content">
            <span class="metric-label">Year to Date</span>
            <span class="metric-value">₹{{ "{:,.0f}".format(ytd_sales|default(0)|float) }}</span>
        </div>
    </div>
    <div class="metric-card">
        <div class="metric-icon"><i class="fas fa-receipt"></i></div>
        <div class="metric-content">
            <span class="metric-label">Avg Transaction</span>
            <span class="metric-value">₹{{ "{:,.0f}".format(avg_transaction|default(0)|float) }}</span>
        </div>
    </div>
    <div class="metric-card">
        <div class="metric-icon"><i class="fas fa-calendar-check"></i></div>
        <div class="metric-content">
            <span class="metric-label">Active Days</span>
            <span class="metric-value">{{ unique_days|default(0) }}</span>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="charts-row">
    <div class="chart-container">
        <div class="chart-header">
            <h2><i class="fas fa-chart-line"></i> Daily Sales Trend (Last 30 Days)</h2>
            <div class="chart-legend">
                <span class="legend-dot" style="background: #667eea;"></span> Daily Sales
            </div>
        </div>
        <canvas id="dailyChart"></canvas>
    </div>
    
    <div class="chart-container">
        <div class="chart-header">
            <h2><i class="fas fa-chart-bar"></i> Monthly Comparison</h2>
            <div class="chart-legend">
                <span class="legend-dot" style="background: #27ae60;"></span> Monthly Sales
            </div>
        </div>
        <canvas id="monthlyChart"></canvas>
    </div>
</div>

<!-- Two Column Layout -->
<div class="two-column">
    <!-- Weekday Analysis -->
    <div class="column">
        <div class="column-header">
            <h2><i class="fas fa-calendar-week"></i> Sales by Day of Week</h2>
        </div>
        {% if weekday_analysis %}
        <div class="table-responsive">
            <table class="analytics-table">
                <thead>
                    <tr>
                        <th>Day</th>
                        <th>Avg Sales (₹)</th>
                        <th>Transactions</th>
                        <th>Performance</th>
                    </tr>
                </thead>
                <tbody>
                    {% for day in weekday_analysis %}
                    <tr>
                        <td>
                            <span class="day-indicator {{ day.day|lower }}">
                                <i class="fas fa-{% if day.day == 'Saturday' or day.day == 'Sunday' %}sun{% else %}briefcase{% endif %}"></i>
                                {{ day.day }}
                            </span>
                        </td>
                        <td class="amount">₹{{ "{:,.0f}".format(day.avg_sales|float) }}</td>
                        <td>{{ day.transactions }}</td>
                        <td>
                            <div class="progress-bar small">
                                {% set max_sales = namespace(value=1) %}
                                {% for d in weekday_analysis %}
                                    {% if d.avg_sales > max_sales.value %}
                                        {% set max_sales.value = d.avg_sales %}
                                    {% endif %}
                                {% endfor %}
                                {% if max_sales.value > 0 %}
                                    <div class="progress" style="--w: {{ ((day.avg_sales / max_sales.value) * 100)|round }}%"></div>
                                {% else %}
                                    <div class="progress" style="width: 0%"></div>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="no-data">No weekday data available</p>
        {% endif %}
    </div>
    
    <!-- Top Products -->
    <div class="column">
        <div class="column-header">
            <h2><i class="fas fa-crown"></i> Top Products (All Time)</h2>
        </div>
        {% if top_products %}
        <div class="table-responsive">
            <table class="analytics-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Product</th>
                        <th>Units Sold</th>
                        <th>Revenue (₹)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in top_products %}
                    <tr>
                        <td><span class="rank-badge">{{ loop.index }}</span></td>
                        <td class="product-name">{{ product.name }}</td>
                        <td>{{ product.quantity }}</td>
                        <td class="amount">₹{{ "{:,.0f}".format(product.revenue|float) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="no-data">No product data available</p>
        {% endif %}
    </div>
</div>

<!-- Category Breakdown -->
<div class="category-breakdown">
    <div class="section-header">
        <h2><i class="fas fa-tags"></i> Category Performance (This Month)</h2>
    </div>
    {% if category_data %}
    <div class="category-grid">
        {% set max_revenue = namespace(value=1) %}
        {% for cat in category_data %}
            {% if cat.revenue > max_revenue.value %}
                {% set max_revenue.value = cat.revenue %}
            {% endif %}
        {% endfor %}
        
        {% for cat in category_data %}
        <div class="category-card">
            <div class="category-icon">
                <i class="fas fa-{% if cat.category == 'Dairy' %}cow{% elif cat.category == 'Snacks' %}cookie-bite{% elif cat.category == 'Beverages' %}wine-bottle{% elif cat.category == 'Grocery' %}shopping-basket{% elif cat.category == 'Personal Care' %}soap{% elif cat.category == 'Household' %}broom{% else %}box{% endif %}"></i>
            </div>
            <div class="category-info">
                <h3>{{ cat.category }}</h3>
                <div class="category-stats">
                    <span class="stat"><strong>{{ cat.sales }}</strong> units</span>
                    <span class="stat"><strong>₹{{ "{:,.0f}".format(cat.revenue|float) }}</strong></span>
                </div>
                <div class="progress-bar">
                    {% if max_revenue.value > 0 %}
                        <div class="progress" style="--w: {{ ((cat.revenue / max_revenue.value) * 100)|round }}%"></div>
                    {% else %}
                        <div class="progress" style="width: 0%"></div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p class="no-data">No category data for this month</p>
    {% endif %}
</div>

<!-- Last 7 Days Details -->
<div class="daily-table">
    <div class="section-header">
        <h2><i class="fas fa-clock"></i> Last 7 Days Performance</h2>
        <span class="badge info">Real-time data</span>
    </div>
    {% if last_7_days %}
    <div class="table-responsive">
        <table class="analytics-table detailed">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Day</th>
                    <th>Transactions</th>
                    <th>Items Sold</th>
                    <th>Revenue (₹)</th>
                    <th>Profit (₹)</th>
                    <th>Margin</th>
                    <th>Trend</th>
                </tr>
            </thead>
            <tbody>
                {% for day in last_7_days %}
                <tr>
                    <td class="date">{{ day.date }}</td>
                    <td><span class="day-badge {{ day.day_name|lower }}">{{ day.day_name }}</span></td>
                    <td class="text-center">{{ day.transactions }}</td>
                    <td class="text-center">{{ day.items_sold }}</td>
                    <td class="amount">₹{{ "{:,.0f}".format(day.revenue|float) }}</td>
                    <td class="amount profit">₹{{ "{:,.0f}".format(day.profit|float) }}</td>
                    <td>
                        <span class="margin-badge {% if day.margin > 25 %}high{% elif day.margin > 15 %}medium{% else %}low{% endif %}">
                            {{ day.margin }}%
                        </span>
                    </td>
                    <td>
                        {% if loop.index > 1 %}
                            {% set prev = last_7_days[loop.index0 - 1] %}
                            {% if prev.revenue and prev.revenue > 0 %}
                                {% if day.revenue > prev.revenue %}
                                    <span class="trend up"><i class="fas fa-arrow-up"></i> +{{ ((day.revenue - prev.revenue) / prev.revenue * 100)|round(1) }}%</span>
                                {% elif day.revenue < prev.revenue %}
                                    <span class="trend down"><i class="fas fa-arrow-down"></i> -{{ ((prev.revenue - day.revenue) / prev.revenue * 100)|round(1) }}%</span>
                                {% else %}
                                    <span class="trend flat"><i class="fas fa-minus"></i> 0%</span>
                                {% endif %}
                            {% endif %}
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="no-data">No recent sales data</p>
    {% endif %}
</div>

<!-- Monthly Breakdown Table -->
<div class="monthly-breakdown">
    <div class="section-header">
        <h2><i class="fas fa-history"></i> Monthly Breakdown (Last 6 Months)</h2>
    </div>
    {% if months_data %}
    <div class="table-responsive">
        <table class="analytics-table">
            <thead>
                <tr>
                    <th>Month</th>
                    <th>Sales (₹)</th>
                    <th>Profit (₹)</th>
                    <th>Margin</th>
                    <th>Growth</th>
                </tr>
            </thead>
            <tbody>
                {% for month in months_data %}
                <tr>
                    <td class="month-cell"><strong>{{ month.month }}</strong></td>
                    <td class="amount">₹{{ "{:,.0f}".format(month.sales|float) }}</td>
                    <td class="amount profit">₹{{ "{:,.0f}".format(month.profit|float) }}</td>
                    <td>
                        {% if month.sales and month.sales > 0 %}
                            {% set margin_percent = ((month.profit / month.sales * 100)|round(1)) %}
                        {% else %}
                            {% set margin_percent = 0 %}
                        {% endif %}
                        <span class="margin-badge {% if margin_percent > 25 %}high{% elif margin_percent > 15 %}medium{% else %}low{% endif %}">
                            {{ margin_percent }}%
                        </span>
                    </td>
                    <td>
                        {% if loop.index > 1 %}
                            {% set prev = months_data[loop.index0 - 1] %}
                            {% if prev.sales and prev.sales > 0 %}
                                {% if month.sales > prev.sales %}
                                    <span class="growth up"><i class="fas fa-arrow-up"></i> +{{ ((month.sales - prev.sales) / prev.sales * 100)|round(1) }}%</span>
                                {% elif month.sales < prev.sales %}
                                    <span class="growth down"><i class="fas fa-arrow-down"></i> -{{ ((prev.sales - month.sales) / prev.sales * 100)|round(1) }}%</span>
                                {% else %}
                                    <span class="growth flat"><i class="fas fa-minus"></i> 0%</span>
                                {% endif %}
                            {% endif %}
                        {% else %}
                            <span class="growth flat">Base</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="no-data">No monthly data available</p>
    {% endif %}
</div>

<style>
    /* Styles specific to analytics can be kept here or moved to style.css */
    /* ... (Keeping existing styles, but omitting general dashboard ones which are now in style.css or used by base) ... */
    /* Only keeping analytics-specific overrides/additions if any. 
       Most styles from previous analytics.html seemed to be general dashboard/card styles. 
       For safety, I'm assuming style.css has the global styles and I only need to include 
       analytics specific ones here if they aren't covered. 
       
       However, viewing style.css showed it had .card, .dashboard, etc.
       I will assume the inline styles from previous analytics.html such as .trend, .growth, .calendar, etc. 
       should be preserved if not in style.css.
    */
    
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
    }
    
    .date-range {
        background: #e2e8f0;
        padding: 8px 16px;
        border-radius: 20px;
        color: #4a5568;
        font-size: 14px;
    }
    
    .metrics-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .metric-card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        display: flex;
        align-items: center;
        gap: 15px;
        transition: transform 0.2s;
    }
    
    .metric-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    
    .metric-icon {
        width: 50px; height: 50px; background: #ebf4ff; border-radius: 12px;
        display: flex; align-items: center; justify-content: center;
        font-size: 24px; color: #667eea;
    }
    
    .metric-content { flex: 1; }
    .metric-label { font-size: 12px; color: #718096; display: block; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
    .metric-value { font-size: 20px; font-weight: bold; color: #2d3748; }

    .charts-row {
        display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;
    }
    
    .chart-container {
        background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .chart-header {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #edf2f7;
    }
    .chart-header h2 { font-size: 18px; color: #2d3748; margin: 0; }
    .chart-legend { font-size: 14px; color: #4a5568; }
    .legend-dot { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 5px; }
    
    .analytics-table { width: 100%; border-collapse: collapse; }
    .analytics-table th { background: #f7fafc; color: #4a5568; font-weight: 600; font-size: 14px; padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0; }
    .analytics-table td { padding: 12px; border-bottom: 1px solid #e2e8f0; color: #2d3748; }
    .analytics-table tbody tr:hover { background: #f7fafc; }
    
    .amount { font-family: monospace; font-weight: 600; color: #2d3748; }
    .profit { color: #27ae60; }
    
    .margin-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500; display: inline-block; }
    .margin-badge.high { background: #c6f6d5; color: #22543d; }
    .margin-badge.medium { background: #feebc8; color: #744210; }
    .margin-badge.low { background: #fed7d7; color: #742a2a; }
    
    .trend, .growth { font-size: 12px; font-weight: 500; display: inline-flex; align-items: center; gap: 3px; }
    .trend.up, .growth.up { color: #27ae60; }
    .trend.down, .growth.down { color: #e74c3c; }
    .trend.flat, .growth.flat { color: #718096; }
    
    @media (max-width: 1200px) { .charts-row { grid-template-columns: 1fr; } }
    @media (max-width: 768px) { .metrics-row { grid-template-columns: 1fr; } .charts-row { grid-template-columns: 1fr; } }
    
    .progress {
        height: 8px;
        background: #667eea;
        border-radius: 4px;
        width: var(--w, 0%);
        transition: width 1s ease-in-out;
    }
</style>
{% endblock %}

{% block scripts %}
<!-- Data Injection -->
<script id="daily-labels" type="application/json">{{ daily_labels|tojson|default('[]')|safe }}</script>
<script id="daily-data" type="application/json">{{ daily_data|tojson|default('[]')|safe }}</script>
<script id="monthly-labels" type="application/json">{{ monthly_labels|tojson|default('[]')|safe }}</script>
<script id="monthly-data" type="application/json">{{ monthly_data|tojson|default('[]')|safe }}</script>

<script>
    // Helper to load JSON data safely
    const loadData = (id) => {
        const element = document.getElementById(id);
        if (!element) {
            console.error('Element not found:', id);
            return [];
        }
        try {
            return JSON.parse(element.textContent);
        } catch (e) {
            console.error('Failed to parse data for ' + id, e);
            return [];
        }
    };

    // Daily Sales Chart
    const dailyCtx = document.getElementById('dailyChart').getContext('2d');
    new Chart(dailyCtx, {
        type: 'line',
        data: {
            labels: loadData('daily-labels'),
            datasets: [{
                label: 'Daily Sales (₹)',
                data: loadData('daily-data'),
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                borderWidth: 3,
                pointBackgroundColor: '#667eea',
                pointBorderColor: 'white',
                pointBorderWidth: 2,
                pointRadius: 4,
                pointHoverRadius: 6,
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) { return '₹' + context.raw.toLocaleString('en-IN'); }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { callback: function(value) { return '₹' + value.toLocaleString('en-IN'); } }
                }
            }
        }
    });

    // Monthly Chart
    const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
    new Chart(monthlyCtx, {
        type: 'bar',
        data: {
            labels: loadData('monthly-labels'),
            datasets: [{
                label: 'Monthly Sales (₹)',
                data: loadData('monthly-data'),
                backgroundColor: '#27ae60',
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) { return '₹' + context.raw.toLocaleString('en-IN'); }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { callback: function(value) { return '₹' + value.toLocaleString('en-IN'); } }
                }
            }
        }
    });
</script>
{% endblock %}